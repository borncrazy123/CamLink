# ğŸ¯ è®¾å¤‡è¿è¡ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°æœºåˆ¶

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### **åŸæœ‰é—®é¢˜**
è®¾å¤‡å“åº”å¼€å§‹/åœæ­¢å½•åˆ¶å‘½ä»¤æ—¶ï¼Œåªè¿”å›ï¼š
```json
{
  "request_id": "67890",
  "result": "success",
  "error_code": 0
}
```

**æ²¡æœ‰åŒ…å« `run_state` å­—æ®µ**ï¼Œå¯¼è‡´ï¼š
- âŒ å‰ç«¯ç‚¹å‡»"å¼€å§‹å½•åˆ¶"åï¼Œ`run_state` ä»ç„¶æ˜¯ `null`
- âŒ "åœæ­¢å½•åˆ¶"æŒ‰é’®ä¸ä¼šç«‹å³å¯ç”¨
- â° éœ€è¦ç­‰å¾…è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥çŠ¶æ€ï¼ˆå¯èƒ½3-10ç§’ï¼‰
- ğŸ˜• ç”¨æˆ·ä½“éªŒå·®

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šæ™ºèƒ½æ¨æ–­æœºåˆ¶

### **æ ¸å¿ƒé€»è¾‘**

**å½“æ”¶åˆ°å‘½ä»¤å“åº”æ—¶ï¼Œäº‘ç«¯æ ¹æ®ä»¥ä¸‹è§„åˆ™è‡ªåŠ¨æ¨æ–­å¹¶æ›´æ–° `run_state`ï¼š**

```python
if result == 'success' and error_code == 0:
    # æŸ¥è¯¢å‘½ä»¤ç±»å‹
    task = get_task_by_requestid(request_id)
    
    if task.requesttype == 'start_record':
        run_state = 'recording'  # å¼€å§‹å½•åˆ¶æˆåŠŸ â†’ å½•åˆ¶ä¸­
    
    elif task.requesttype == 'stop_record':
        run_state = 'stopped'    # åœæ­¢å½•åˆ¶æˆåŠŸ â†’ å·²åœæ­¢
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### **1. å¼€å§‹å½•åˆ¶æµç¨‹**

```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹å½•åˆ¶" â–¶
    â†“
äº‘ç«¯å‘é€ MQTT å‘½ä»¤
Topic: camera/<client_id>/cmd
{
  "action": "start_record",
  "request_id": "req_123",
  "pre_name": "702æˆ¿é—´"
}
    â†“
è®¾å¤‡æ‰§è¡Œå½•åˆ¶å¹¶å“åº”
Topic: camera/<client_id>/resp
{
  "request_id": "req_123",
  "result": "success",
  "error_code": 0
}
    â†“
äº‘ç«¯æ™ºèƒ½æ¨æ–­ ğŸ§ 
1. æŸ¥è¯¢ tasks è¡¨ï¼Œè·å– requesttype = "start_record"
2. åˆ¤æ–­ï¼šresult=success + error_code=0
3. æ¨æ–­ï¼šè®¾å¤‡å·²å¼€å§‹å½•åˆ¶
4. æ›´æ–°ï¼šrun_state = "recording"
    â†“
å‰ç«¯ç«‹å³åˆ·æ–° âš¡
- è¿è¡ŒçŠ¶æ€ï¼šnull â†’ "å½•åˆ¶ä¸­" ğŸ”´
- åœæ­¢å½•åˆ¶æŒ‰é’®ï¼šç¦ç”¨ â†’ å¯ç”¨ âœ…
- å¼€å§‹å½•åˆ¶æŒ‰é’®ï¼šå¯ç”¨ â†’ ç¦ç”¨ âŒ
```

### **2. åœæ­¢å½•åˆ¶æµç¨‹**

```
ç”¨æˆ·ç‚¹å‡»"åœæ­¢å½•åˆ¶" â¹
    â†“
äº‘ç«¯å‘é€ MQTT å‘½ä»¤
{
  "action": "stop_record",
  "request_id": "req_456"
}
    â†“
è®¾å¤‡åœæ­¢å½•åˆ¶å¹¶å“åº”
{
  "request_id": "req_456",
  "result": "success",
  "error_code": 0
}
    â†“
äº‘ç«¯æ™ºèƒ½æ¨æ–­ ğŸ§ 
1. æŸ¥è¯¢ tasks è¡¨ï¼Œè·å– requesttype = "stop_record"
2. åˆ¤æ–­ï¼šresult=success + error_code=0
3. æ¨æ–­ï¼šè®¾å¤‡å·²åœæ­¢å½•åˆ¶
4. æ›´æ–°ï¼šrun_state = "stopped"
    â†“
å‰ç«¯ç«‹å³åˆ·æ–° âš¡
- è¿è¡ŒçŠ¶æ€ï¼š"å½•åˆ¶ä¸­" â†’ "å·²åœæ­¢"
- åœæ­¢å½•åˆ¶æŒ‰é’®ï¼šå¯ç”¨ â†’ ç¦ç”¨ âŒ
- å¼€å§‹å½•åˆ¶æŒ‰é’®ï¼šç¦ç”¨ â†’ å¯ç”¨ âœ…
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### **ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/monitor_cam/status_listener.py`**

#### **å…³é”®ä»£ç ï¼ˆç¬¬176-200è¡Œï¼‰**ï¼š

```python
# ğŸ”¥ å½“å‘½ä»¤æˆåŠŸæ‰§è¡Œï¼ˆerror_code=0ï¼‰æ—¶ï¼Œæ ¹æ®å‘½ä»¤ç±»å‹è‡ªåŠ¨æ›´æ–° run_state
if error_code == 0:
    # ä»tasksè¡¨æŸ¥è¯¢å‘½ä»¤ç±»å‹
    task = get_task_by_requestid(request_id)
    if task:
        request_type = task.get('requesttype')
        
        # æ ¹æ®å‘½ä»¤ç±»å‹æ¨æ–­è®¾å¤‡è¿è¡ŒçŠ¶æ€
        new_run_state = None
        if request_type == 'start_record':
            new_run_state = 'recording'
            print(f"ğŸ¬ å¼€å§‹å½•åˆ¶å‘½ä»¤æˆåŠŸï¼Œæ›´æ–° run_state = recording")
        elif request_type == 'stop_record':
            new_run_state = 'stopped'
            print(f"â¹ï¸  åœæ­¢å½•åˆ¶å‘½ä»¤æˆåŠŸï¼Œæ›´æ–° run_state = stopped")
        
        # æ›´æ–°è®¾å¤‡è¿è¡ŒçŠ¶æ€
        if new_run_state:
            status_update = {
                'run_state': new_run_state,
                'status': 'online'  # æ—¢ç„¶èƒ½å“åº”å‘½ä»¤ï¼Œè¯´æ˜è®¾å¤‡åœ¨çº¿
            }
            device_status_manager.update_status(camera_id, status_update)
            update_device_status_to_db(camera_id, status_update)
            print(f"âœ… å·²è‡ªåŠ¨æ›´æ–°è®¾å¤‡è¿è¡ŒçŠ¶æ€: run_state={new_run_state}")
```

---

## ğŸ“Š çŠ¶æ€æ›´æ–°ç­–ç•¥

### **ä¼˜å…ˆçº§è§„åˆ™**

1. **æœ€é«˜ä¼˜å…ˆçº§**ï¼šå“åº”ä¸­æ˜ç¡®åŒ…å« `run_state` å­—æ®µ
   ```json
   {
     "result": "success",
     "error_code": 0,
     "run_state": "recording"  â† ç›´æ¥ä½¿ç”¨
   }
   ```

2. **æ¬¡è¦ä¼˜å…ˆçº§**ï¼šæ ¹æ®å‘½ä»¤ç±»å‹æ™ºèƒ½æ¨æ–­
   ```json
   {
     "result": "success",
     "error_code": 0
   }
   ```
   â†’ æŸ¥è¯¢ tasks è¡¨ â†’ æ¨æ–­ run_state

3. **å…œåº•æœºåˆ¶**ï¼šç­‰å¾…è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥
   ```
   Topic: camera/<client_id>/state
   {
     "run_state": "recording",
     ...
   }
   ```

---

## âœ… ä¼˜åŠ¿å¯¹æ¯”

### **æ”¹è¿›å‰**

| æ“ä½œ | çŠ¶æ€æ›´æ–°æ—¶æœº | å»¶è¿Ÿ | ç”¨æˆ·ä½“éªŒ |
|-----|------------|------|---------|
| å¼€å§‹å½•åˆ¶ | ç­‰å¾…è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥ | 3-10ç§’ | âŒ å·® |
| åœæ­¢å½•åˆ¶ | ç­‰å¾…è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥ | 3-10ç§’ | âŒ å·® |

### **æ”¹è¿›å**

| æ“ä½œ | çŠ¶æ€æ›´æ–°æ—¶æœº | å»¶è¿Ÿ | ç”¨æˆ·ä½“éªŒ |
|-----|------------|------|---------|
| å¼€å§‹å½•åˆ¶ | ç«‹å³æ¨æ–­æ›´æ–° | <1ç§’ | âœ… ä¼˜ç§€ |
| åœæ­¢å½•åˆ¶ | ç«‹å³æ¨æ–­æ›´æ–° | <1ç§’ | âœ… ä¼˜ç§€ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### **æµ‹è¯•æ­¥éª¤**

1. **å¯åŠ¨åº”ç”¨**
   ```bash
   python run.py
   ```

2. **æ‰“å¼€è®¾å¤‡ç®¡ç†é¡µé¢**
   ```
   http://localhost:5001/device_manage
   ```

3. **æµ‹è¯•å¼€å§‹å½•åˆ¶**
   - ç‚¹å‡» â–¶ "å¼€å§‹å½•åˆ¶"æŒ‰é’®
   - è¾“å…¥ä¸šåŠ¡æ ‡è¯†ï¼ˆå¦‚ï¼š`702æˆ¿é—´`ï¼‰
   - ç¡®è®¤å‘é€
   - **è§‚å¯Ÿ**ï¼šè¿è¡ŒçŠ¶æ€åº”ç«‹å³å˜ä¸º"å½•åˆ¶ä¸­" ğŸ”´
   - **éªŒè¯**ï¼šâ¹ "åœæ­¢å½•åˆ¶"æŒ‰é’®åº”ç«‹å³å¯ç”¨

4. **æµ‹è¯•åœæ­¢å½•åˆ¶**
   - ç‚¹å‡» â¹ "åœæ­¢å½•åˆ¶"æŒ‰é’®
   - **è§‚å¯Ÿ**ï¼šè¿è¡ŒçŠ¶æ€åº”ç«‹å³å˜ä¸º"å·²åœæ­¢"
   - **éªŒè¯**ï¼šâ–¶ "å¼€å§‹å½•åˆ¶"æŒ‰é’®åº”ç«‹å³å¯ç”¨

---

## ğŸ“ æ—¥å¿—è¾“å‡º

### **å¼€å§‹å½•åˆ¶æˆåŠŸ**
```
âœ… å·²å­˜å‚¨å‘½ä»¤å“åº” (camera: HW-2024-001, request: req_123, result: success)
âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæˆåŠŸ: request_id=req_123
ğŸ¬ å¼€å§‹å½•åˆ¶å‘½ä»¤æˆåŠŸï¼Œæ›´æ–° run_state = recording
âœ… å·²è‡ªåŠ¨æ›´æ–°è®¾å¤‡è¿è¡ŒçŠ¶æ€: run_state=recording
```

### **åœæ­¢å½•åˆ¶æˆåŠŸ**
```
âœ… å·²å­˜å‚¨å‘½ä»¤å“åº” (camera: HW-2024-001, request: req_456, result: success)
âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæˆåŠŸ: request_id=req_456
â¹ï¸  åœæ­¢å½•åˆ¶å‘½ä»¤æˆåŠŸï¼Œæ›´æ–° run_state = stopped
âœ… å·²è‡ªåŠ¨æ›´æ–°è®¾å¤‡è¿è¡ŒçŠ¶æ€: run_state=stopped
```

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### **âœ… é€‚ç”¨**
- è®¾å¤‡å“åº”åªåŒ…å« `result` å’Œ `error_code`
- éœ€è¦ç«‹å³åé¦ˆç»™ç”¨æˆ·
- å‘½ä»¤æ‰§è¡ŒæˆåŠŸå³ä»£è¡¨çŠ¶æ€å·²æ”¹å˜

### **âŒ ä¸é€‚ç”¨**
- å‘½ä»¤æ‰§è¡Œå¼‚æ­¥ï¼ˆå‘é€æˆåŠŸ â‰  æ‰§è¡ŒæˆåŠŸï¼‰
- éœ€è¦ç­‰å¾…ç‰©ç†æ“ä½œå®Œæˆï¼ˆå¦‚æœºæ¢°è‡‚ï¼‰
- çŠ¶æ€å˜åŒ–ä¸ç¡®å®š

---

## ğŸš€ æ‰©å±•èƒ½åŠ›

### **æœªæ¥å¯æ”¯æŒæ›´å¤šå‘½ä»¤**

```python
# æ ¹æ®å‘½ä»¤ç±»å‹æ¨æ–­è®¾å¤‡è¿è¡ŒçŠ¶æ€
if request_type == 'start_record':
    new_run_state = 'recording'
elif request_type == 'stop_record':
    new_run_state = 'stopped'
elif request_type == 'start_upload':
    new_run_state = 'uploading'  # æ‰©å±•ï¼šä¸Šä¼ ä¸­
elif request_type == 'pause_record':
    new_run_state = 'paused'     # æ‰©å±•ï¼šæš‚åœå½•åˆ¶
# ... æ›´å¤šçŠ¶æ€
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **å®ç°ä»£ç **: `app/src/monitor_cam/status_listener.py` (ç¬¬176-200è¡Œ)
- **è®¾å¤‡çŠ¶æ€ç®¡ç†**: `app/src/monitor_cam/device_status.py`
- **ä»»åŠ¡è¡¨æŸ¥è¯¢**: `app/src/sqllite/sqllite_task.py`

---

## âœ… æ€»ç»“

**ç°åœ¨çš„å·¥ä½œæµç¨‹**ï¼š

1. âœ… ç”¨æˆ·ç‚¹å‡»"å¼€å§‹å½•åˆ¶"
2. âœ… è®¾å¤‡å“åº” `error_code=0`ï¼ˆè¡¨ç¤ºæˆåŠŸï¼‰
3. âœ… äº‘ç«¯æ™ºèƒ½æ¨æ–­ `run_state = recording`
4. âœ… å‰ç«¯ç«‹å³æ›´æ–°ï¼Œ"åœæ­¢å½•åˆ¶"æŒ‰é’®å¯ç”¨
5. âœ… æ— éœ€ç­‰å¾…è®¾å¤‡ä¸»åŠ¨ä¸ŠæŠ¥

**ç”¨æˆ·ä½“éªŒ**ï¼šä» **3-10ç§’å»¶è¿Ÿ** é™ä½åˆ° **<1ç§’å“åº”** âš¡

**æ™ºèƒ½æ¨æ–­æœºåˆ¶å·²å®Œå…¨é›†æˆï¼** ğŸ‰

