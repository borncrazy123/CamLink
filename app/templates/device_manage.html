<!DOCTYPE html>
<html>
<head>
    <title>æ‘„åƒå¤´ç®¡ç†ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { background: #f5f7fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 32px 0; }
        .header { display: flex; align-items: center; gap: 16px; margin-bottom: 8px; }
        .header-logo { font-size: 32px; color: #1976d2; }
        .header-title { font-size: 22px; font-weight: 700; }
        .header-sub { font-size: 16px; color: #7a7a7a; margin-left: 8px; }
        .stats-row { display: flex; gap: 32px; margin: 32px 0 24px 0; }
        .stat-card { background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 24px 32px; min-width: 180px; display: flex; flex-direction: column; align-items: flex-start; }
        .stat-label { font-size: 15px; color: #7a7a7a; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #222; display: flex; align-items: center; gap: 8px; }
        .stat-icon { font-size: 28px; color: #1976d2; }
        .stat-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .stat-dot.online { background: #2ecc40; }
        .stat-dot.offline { background: #b0b3b8; }
        .stat-dot.error { background: #ff3b30; }
        .search-bar { margin: 24px 0; }
        .search-input { width: 100%; max-width: 600px; padding: 12px 18px; border-radius: 10px; border: 1px solid #e5e7eb; background: #f6f7fa; font-size: 16px; }
        .device-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .device-table th, .device-table td { padding: 12px 8px; text-align: left; font-size: 15px; }
        .device-table th { background: #f5f7fa; color: #7a7a7a; font-weight: 600; }
        .device-table tr:not(:last-child) { border-bottom: 1px solid #f0f0f0; }
        .status-tag { padding: 4px 14px; border-radius: 12px; color: #fff; font-size: 14px; font-weight: 600; display: inline-block; }
        .status-online { background: #2ecc40; }
        .status-offline { background: #b0b3b8; }
        .status-error { background: #ff3b30; }
        .status-recording { background: #ff9500; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 20px; margin: 0 4px; color: #222; transition: all 0.2s; }
        .icon-btn:hover { color: #1976d2; transform: scale(1.1); }
        .icon-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .device-icon { font-size: 18px; color: #1976d2; margin-right: 4px; }
        .location-icon { font-size: 16px; color: #1976d2; margin-right: 4px; }

        /* Toast notification */
        .toast { position: fixed; top: 20px; right: 20px; background: #fff; padding: 16px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 3000; min-width: 280px; }
        .toast.show { display: block; animation: slideIn 0.3s ease-out; }
        .toast.success { border-left: 4px solid #2ecc40; }
        .toast.error { border-left: 4px solid #ff3b30; }
        .toast.info { border-left: 4px solid #1976d2; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }

        /* Modal styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: #fff; width: 520px; max-height: 86vh; overflow: hidden; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .modal.large { width: 720px; }
        .modal-header { padding: 18px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0; }
        .modal-title { font-size:18px; font-weight:700; display:flex; gap:10px; align-items:center }
        .modal-body { padding: 16px 18px; overflow:auto; max-height: 60vh; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #1976d2; }
        .close-x { background:none;border:none;font-size:18px;cursor:pointer;color:#6b7280 }
        .modal-footer { padding: 10px 18px; border-top:1px solid #f0f0f0; text-align:right; display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #1976d2; color: #fff; }
        .btn-primary:hover { background: #1565c0; }
        .btn-secondary { background: #e5e7eb; color: #333; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Video list */
        .video-item { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .video-item.selected { background: #e3f2fd; border-color: #1976d2; }
        .video-info { flex: 1; }
        .video-name { font-weight: 600; color: #333; margin-bottom: 4px; }
        .video-meta { font-size: 13px; color: #6b7280; }
        .video-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: #2ecc40; transition: width 0.3s; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Device table row hover */
        .device-table tbody tr { cursor: pointer; transition: background 0.2s; }
        .device-table tbody tr:hover { background: #f5f7fa; }
        
        /* Timeline items */
        .timeline-item { padding: 12px; border-left: 3px solid #e5e7eb; margin-left: 8px; margin-bottom: 12px; position: relative; }
        .timeline-item.success { border-left-color: #2ecc40; }
        .timeline-item.info { border-left-color: #1976d2; }
        .timeline-item.warning { border-left-color: #ff9500; }
        .timeline-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .timeline-dot.green { background: #2ecc40; }
        .timeline-dot.blue { background: #1976d2; }
        .timeline-dot.orange { background: #ff9500; }
        .timeline-time { position: absolute; right: 8px; top: 12px; color: #6b7280; font-size: 12px; }
        .timeline-title { font-weight: 600; margin-bottom: 6px; color: #333; }
        .timeline-desc { color: #6b7280; font-size: 14px; }
        
        /* File list items */
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; }
        .file-item:hover { background: #f5f7fa; border-color: #1976d2; }
        .file-icon { font-size: 24px; margin-right: 12px; }
        .file-info { flex: 1; }
        .file-name { font-weight: 600; color: #333; margin-bottom: 4px; }
        .file-meta { font-size: 13px; color: #6b7280; }
        .file-actions { display: flex; gap: 8px; }
        .file-action-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
        .file-action-btn:hover { background: #e5e7eb; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <span class="header-logo">ğŸ“·</span>
            <span class="header-title">æ‘„åƒå¤´ç®¡ç†ä¸­å¿ƒ</span>
            <span class="header-sub">MQTT è®¾å¤‡ç›‘æ§ä¸ç®¡ç†</span>
            <button onclick="refreshDeviceList()" style="margin-left: auto; padding: 8px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer;">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
                <div class="stat-value" id="totalDevices">0 <span class="stat-icon">ğŸ“·</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
                <div class="stat-value"><span class="stat-dot online"></span><span id="onlineDevices">0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç¦»çº¿è®¾å¤‡</div>
                <div class="stat-value"><span class="stat-dot offline"></span><span id="offlineDevices">0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å½•åˆ¶ä¸­</div>
                <div class="stat-value"><span class="stat-dot error"></span><span id="recordingDevices">0</span></div>
            </div>
        </div>
        <div class="search-bar">
            <input class="search-input" type="text" placeholder="æœç´¢æ‘„åƒå¤´ID...">
        </div>
        <table class="device-table">
            <thead>
                <tr>
                    <th>çŠ¶æ€</th>
                    <th>æ‘„åƒå¤´ID</th>
                    <th>è¿è¡ŒçŠ¶æ€</th>
                    <th>å‰©ä½™å®¹é‡</th>
                    <th>ç”µé‡</th>
                    <th>ä¿¡å·å¼ºåº¦</th>
                    <th>æœ€åæ›´æ–°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="deviceTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                        <div class="loading" style="margin: 0 auto 10px;"></div>
                        <div>åŠ è½½è®¾å¤‡åˆ—è¡¨ä¸­...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="deviceDetailModal" class="modal-overlay">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">ğŸ“· æ‘„åƒå¤´è¯¦æƒ… - <span id="detailCameraId"></span></div>
                <button class="close-x" onclick="closeModal('deviceDetailModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <!-- è®¾å¤‡ä¿¡æ¯ç½‘æ ¼ -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px 16px; margin-bottom: 20px; padding: 16px; background: #f5f7fa; border-radius: 12px;">
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">çŠ¶æ€</div>
                        <div id="detail_status"></div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">å®¢æˆ·ç«¯ID</div>
                        <div id="detail_clientid" style="font-size: 14px; color: #333;">-</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">æ‰€å±é…’åº—</div>
                        <div id="detail_hotel" style="font-size: 14px; color: #333;">-</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">å®‰è£…ä½ç½®</div>
                        <div id="detail_location" style="font-size: 14px; color: #333;">-</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">WiFiç½‘ç»œ</div>
                        <div id="detail_wifi" style="font-size: 14px; color: #333;">-</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">è¿è¡Œæ—¶é•¿</div>
                        <div id="detail_runtime" style="font-size: 14px; color: #333;">-</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">å›ºä»¶ç‰ˆæœ¬</div>
                        <div id="detail_firmware" style="font-size: 14px; color: #333;">v2.1.3</div>
                    </div>
                    <div>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 4px;">æœ€ååœ¨çº¿</div>
                        <div id="detail_lastonline" style="font-size: 14px; color: #333;">-</div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’®è¡Œ -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="startRecordFromDetail()" id="detailBtnStart">â–¶ å¯åŠ¨å½•åˆ¶</button>
                    <button class="btn btn-secondary" onclick="stopRecordFromDetail()" id="detailBtnStop">â¹ åœæ­¢å½•åˆ¶</button>
                    <button class="btn btn-secondary" onclick="refreshDeviceDetail()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    <button class="btn btn-secondary" onclick="uploadConfig()">ğŸ“¤ ä¸Šä¼ é…ç½®</button>
                </div>

                <!-- æ ‡ç­¾é¡µ -->
                <div style="display: flex; gap: 8px; background: #f5f7fa; padding: 6px; border-radius: 8px; margin-bottom: 16px;">
                    <div class="tab active" onclick="switchDetailTab('timeline')" id="tab-timeline">ğŸ“Š æ“ä½œåŠ¨æ€</div>
                    <div class="tab" onclick="switchDetailTab('files')" id="tab-files">ğŸ“ æ–‡ä»¶åˆ—è¡¨</div>
                </div>

                <!-- æ“ä½œåŠ¨æ€æ ‡ç­¾é¡µå†…å®¹ -->
                <div id="timelineContent" style="max-height: 300px; overflow-y: auto;">
                    <div id="timelineList"></div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨æ ‡ç­¾é¡µå†…å®¹ -->
                <div id="filesContent" style="display: none;">
                    <div id="filesList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="deleteDeviceFromDetail()" style="background:#ff3b30;color:#fff;border:none;">åˆ é™¤è®¾å¤‡</button>
                <button class="btn btn-secondary" onclick="closeModal('deviceDetailModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¼€å§‹å½•åˆ¶æ¨¡æ€æ¡† -->
    <div id="startRecordModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">â–¶ï¸ å¯åŠ¨å½•åˆ¶</div>
                <button class="close-x" onclick="closeModal('startRecordModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ‘„åƒå¤´ID</label>
                    <input type="text" id="recordCameraId" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸šåŠ¡æ ‡è¯† (pre_name)</label>
                    <input type="text" id="recordPreName" class="form-input" placeholder="ä¾‹å¦‚ï¼š702æˆ¿é—´ã€ä¼šè®®å®¤Aã€åœè½¦åœºå—é—¨">
                    <small style="color: #6b7280; font-size: 13px;">ç”¨äºæ ‡è¯†æœ¬æ¬¡å½•åˆ¶çš„ä¸šåŠ¡åœºæ™¯ï¼Œä¼šä½œä¸ºè§†é¢‘æ–‡ä»¶åçš„ä¸€éƒ¨åˆ†</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('startRecordModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmStartRecord()">ç¡®è®¤å¯åŠ¨</button>
            </div>
        </div>
                    </div>

    <!-- è§†é¢‘åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="videoListModal" class="modal-overlay">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ è§†é¢‘æ–‡ä»¶åˆ—è¡¨ - <span id="videoListCameraId"></span></div>
                <button class="close-x" onclick="closeModal('videoListModal')">âœ•</button>
                        </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="queryVideoList()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                    <button class="btn btn-primary" onclick="showUploadModal()" id="btnSelectUpload" disabled>ğŸ“¤ ä¸Šä¼ é€‰ä¸­çš„æ–‡ä»¶ (<span id="selectedCount">0</span>)</button>
                        </div>
                <div id="videoListContent">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div class="loading" style="margin: 0 auto 10px;"></div>
                        <div>åŠ è½½è§†é¢‘åˆ—è¡¨ä¸­...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('videoListModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="uploadConfirmModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ“¤ ç¡®è®¤ä¸Šä¼ </div>
                <button class="close-x" onclick="closeModal('uploadConfirmModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 12px; color: #333;">ç¡®è®¤ä¸Šä¼ ä»¥ä¸‹ <strong id="uploadFileCount">0</strong> ä¸ªè§†é¢‘æ–‡ä»¶ï¼Ÿ</p>
                <div id="uploadFileList" style="max-height: 200px; overflow: auto; background: #f5f7fa; padding: 12px; border-radius: 8px; font-size: 14px; color: #333;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('uploadConfirmModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmUpload()">ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <script>
        let currentCameraId = '';
        let currentVideos = [];
        let selectedVideos = new Set();
        let uploadProgressInterval = null;

        // æ˜¾ç¤ºToastæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        async function refreshDeviceList() {
            try {
                const response = await fetch('/api/camera/status/list');
                const result = await response.json();
                
                if (result.success) {
                    updateDeviceTable(result.data);
                    updateStatistics(result.data);
                } else {
                    showToast('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error fetching device list:', error);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatistics(devices) {
            const total = devices.length;
            const online = devices.filter(d => d.status === 'online').length;
            const offline = devices.filter(d => d.status === 'offline').length;
            const recording = devices.filter(d => d.run_state === 'recording').length;
            
            document.getElementById('totalDevices').innerHTML = `${total} <span class="stat-icon">ğŸ“·</span>`;
            document.getElementById('onlineDevices').textContent = online;
            document.getElementById('offlineDevices').textContent = offline;
            document.getElementById('recordingDevices').textContent = recording;
        }

        // å­˜å‚¨è®¾å¤‡æ•°æ®
        let devicesData = [];

        // æ›´æ–°è®¾å¤‡è¡¨æ ¼
        function updateDeviceTable(devices) {
            devicesData = devices; // ä¿å­˜è®¾å¤‡æ•°æ®
            const tbody = document.getElementById('deviceTableBody');
            
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— è®¾å¤‡æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = devices.map((device, index) => `
                <tr onclick="openDeviceDetail('${device.camera_id}', event)">
                    <td><span class="status-tag ${device.status === 'online' ? 'status-online' : 'status-offline'}">${device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span></td>
                    <td><span class="device-icon">ğŸ“·</span>${device.camera_id}</td>
                    <td><span class="status-tag ${device.run_state === 'recording' ? 'status-recording' : 'status-offline'}">${device.run_state === 'recording' ? 'å½•åˆ¶ä¸­' : device.run_state}</span></td>
                    <td>${device.left_storage || 0} GB</td>
                    <td>${Math.round((parseFloat(device.electric_percent) || 0) * 100)}%</td>
                    <td>${device.network_signal_strength || 0} dBm</td>
                    <td>${formatTime(device.last_update)}</td>
                    <td onclick="event.stopPropagation()">
                        <button class="icon-btn" title="å¯åŠ¨å½•åˆ¶" onclick="openStartRecordModal('${device.camera_id}')" ${device.run_state === 'recording' ? 'disabled' : ''}>â–¶</button>
                        <button class="icon-btn" title="åœæ­¢å½•åˆ¶" onclick="stopRecord('${device.camera_id}')" ${device.run_state !== 'recording' ? 'disabled' : ''}>â¹</button>
                        <button class="icon-btn" title="æŸ¥çœ‹è§†é¢‘" onclick="openVideoListModal('${device.camera_id}')">ğŸ“</button>
                        <button class="icon-btn" title="æŸ¥çœ‹è¿›åº¦" onclick="openUploadProgressModal('${device.camera_id}')">ğŸ“Š</button>
                        <button class="icon-btn" title="åˆ é™¤è®¾å¤‡" onclick="confirmDeleteDevice('${device.camera_id}')" style="color: #ff3b30;">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return `${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
        }

        // 1. å¼€å§‹å½•åˆ¶
        function openStartRecordModal(cameraId) {
            currentCameraId = cameraId;
            document.getElementById('recordCameraId').value = cameraId;
            document.getElementById('recordPreName').value = '';
            openModal('startRecordModal');
        }

        async function confirmStartRecord() {
            const preName = document.getElementById('recordPreName').value.trim();
            
            if (!preName) {
                showToast('è¯·è¾“å…¥ä¸šåŠ¡æ ‡è¯†', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/camera/${currentCameraId}/record/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pre_name: preName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('å½•åˆ¶å¯åŠ¨å‘½ä»¤å·²å‘é€', 'success');
                    closeModal('startRecordModal');
                    setTimeout(refreshDeviceList, 1500);
                } else {
                    showToast(result.message || 'å¯åŠ¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error starting record:', error);
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // 2. åœæ­¢å½•åˆ¶
        async function stopRecord(cameraId) {
            if (!confirm(`ç¡®è®¤åœæ­¢æ‘„åƒå¤´ ${cameraId} çš„å½•åˆ¶ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/camera/${cameraId}/record/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})  // å‘é€ç©ºçš„ JSON å¯¹è±¡
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('å½•åˆ¶åœæ­¢å‘½ä»¤å·²å‘é€', 'success');
                    setTimeout(refreshDeviceList, 1500);
                } else {
                    showToast(result.message || 'åœæ­¢å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error stopping record:', error);
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // 3. æŸ¥çœ‹è§†é¢‘åˆ—è¡¨
        function openVideoListModal(cameraId) {
            currentCameraId = cameraId;
            selectedVideos.clear();
            document.getElementById('videoListCameraId').textContent = cameraId;
            document.getElementById('selectedCount').textContent = '0';
            document.getElementById('btnSelectUpload').disabled = true;
            openModal('videoListModal');
            queryVideoList();
        }

        async function queryVideoList() {
            const content = document.getElementById('videoListContent');
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;"><div class="loading" style="margin: 0 auto 10px;"></div><div>æŸ¥è¯¢è§†é¢‘åˆ—è¡¨ä¸­...</div></div>';
            
            try {
                // å…ˆå‘é€æŸ¥è¯¢å‘½ä»¤
                const cmdResponse = await fetch(`/api/camera/${currentCameraId}/videos/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const cmdResult = await cmdResponse.json();
                
                if (!cmdResult.success) {
                    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #ff3b30;">æŸ¥è¯¢å¤±è´¥ï¼š${cmdResult.message}</div>`;
                    return;
                }
                
                // ç­‰å¾…1ç§’åè·å–ç»“æœ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const resultResponse = await fetch(`/api/videos/${cmdResult.request_id}`);
                const result = await resultResponse.json();
                
                if (result.success && result.data.videos) {
                    currentVideos = result.data.videos;
                    renderVideoList(result.data.videos);
                } else {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— è§†é¢‘æ–‡ä»¶</div>';
                }
            } catch (error) {
                console.error('Error querying videos:', error);
                content.innerHTML = `<div style="text-align: center; padding: 40px; color: #ff3b30;">ç½‘ç»œé”™è¯¯ï¼š${error.message}</div>`;
            }
        }

        function renderVideoList(videos) {
            const content = document.getElementById('videoListContent');
            
            if (videos.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— è§†é¢‘æ–‡ä»¶</div>';
                return;
            }
            
            content.innerHTML = videos.map((video, index) => `
                <div class="video-item" id="video-${index}">
                    <div class="video-info">
                        <div class="video-name">ğŸ“¹ ${video.file_name}</div>
                        <div class="video-meta">
                            å¼€å§‹æ—¶é—´: ${video.start_time} | 
                            æ—¶é•¿: ${video.duration}s | 
                            å¤§å°: ${(video.size / 1024 / 1024).toFixed(2)} MB
                        </div>
                    </div>
                    <input type="checkbox" class="video-checkbox" onchange="toggleVideoSelection('${video.file_name}', ${index})">
                </div>
            `).join('');
        }

        function toggleVideoSelection(fileName, index) {
            if (selectedVideos.has(fileName)) {
                selectedVideos.delete(fileName);
                document.getElementById(`video-${index}`).classList.remove('selected');
            } else {
                selectedVideos.add(fileName);
                document.getElementById(`video-${index}`).classList.add('selected');
            }
            
            document.getElementById('selectedCount').textContent = selectedVideos.size;
            document.getElementById('btnSelectUpload').disabled = selectedVideos.size === 0;
        }

        // 4. ä¸Šä¼ æ–‡ä»¶
        function showUploadModal() {
            if (selectedVideos.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„è§†é¢‘', 'error');
                return;
            }
            
            document.getElementById('uploadFileCount').textContent = selectedVideos.size;
            document.getElementById('uploadFileList').innerHTML = Array.from(selectedVideos).map(f => `<div style="margin: 4px 0;">ğŸ“¹ ${f}</div>`).join('');
            openModal('uploadConfirmModal');
        }

        async function confirmUpload() {
            const fileList = Array.from(selectedVideos);
            
            try {
                const response = await fetch(`/api/camera/${currentCameraId}/videos/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_name_list: fileList })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`ä¸Šä¼ å‘½ä»¤å·²å‘é€ï¼Œå…± ${fileList.length} ä¸ªæ–‡ä»¶`, 'success');
                    closeModal('uploadConfirmModal');
                    closeModal('videoListModal');
                    
                    // å¼€å§‹ç›‘æ§ä¸Šä¼ è¿›åº¦
                    startUploadProgressMonitor(currentCameraId);
                } else {
                    showToast(result.message || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error uploading files:', error);
                showToast('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æŸ¥çœ‹ä¸Šä¼ è¿›åº¦
        function openUploadProgressModal(cameraId) {
            showToast('æ­£åœ¨æŸ¥è¯¢ä¸Šä¼ è¿›åº¦...', 'info');
            fetchUploadProgress(cameraId);
        }

        async function fetchUploadProgress(cameraId) {
            try {
                const response = await fetch(`/api/camera/${cameraId}/videos/upload/status`);
                const result = await response.json();
                
                if (result.success && Object.keys(result.progress).length > 0) {
                    let message = `ğŸ“Š ${cameraId} ä¸Šä¼ è¿›åº¦ï¼š\n`;
                    for (const [file, progress] of Object.entries(result.progress)) {
                        message += `${file}: ${(progress * 100).toFixed(0)}%\n`;
                    }
                    alert(message);
                } else {
                    showToast('å½“å‰æ— ä¸Šä¼ ä»»åŠ¡', 'info');
                }
            } catch (error) {
                console.error('Error fetching progress:', error);
                showToast('æŸ¥è¯¢å¤±è´¥', 'error');
            }
        }

        function startUploadProgressMonitor(cameraId) {
            if (uploadProgressInterval) {
                clearInterval(uploadProgressInterval);
            }
            
            uploadProgressInterval = setInterval(async () => {
                const response = await fetch(`/api/camera/${cameraId}/videos/upload/status`);
                const result = await response.json();
                
                if (result.success && Object.keys(result.progress).length > 0) {
                    const allComplete = Object.values(result.progress).every(p => p >= 1.0);
                    if (allComplete) {
                        clearInterval(uploadProgressInterval);
                        showToast('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼', 'success');
                    }
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°
        window.addEventListener('load', () => {
            refreshDeviceList();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
            setInterval(refreshDeviceList, 30000);
        });

        // ========== è®¾å¤‡è¯¦æƒ…æ¨¡æ€æ¡† ==========
        let currentDetailDevice = null;
        let detailTimeline = [];
        let detailFiles = [];

        // æ‰“å¼€è®¾å¤‡è¯¦æƒ…
        function openDeviceDetail(cameraId, event) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ‰“å¼€è¯¦æƒ…
            if (event && event.target.closest('button')) {
                return;
            }
            
            currentCameraId = cameraId;
            currentDetailDevice = devicesData.find(d => d.camera_id === cameraId);
            
            if (!currentDetailDevice) {
                showToast('è®¾å¤‡ä¿¡æ¯ä¸å­˜åœ¨', 'error');
                return;
            }
            
            // å¡«å……è®¾å¤‡ä¿¡æ¯
            document.getElementById('detailCameraId').textContent = cameraId;
            
            const statusHtml = currentDetailDevice.status === 'online' 
                ? '<span class="status-tag status-online">åœ¨çº¿</span>' 
                : '<span class="status-tag status-offline">ç¦»çº¿</span>';
            document.getElementById('detail_status').innerHTML = statusHtml;
            
            document.getElementById('detail_clientid').textContent = currentDetailDevice.client_id || '-';
            document.getElementById('detail_hotel').textContent = currentDetailDevice.hotel || '-';
            document.getElementById('detail_location').textContent = currentDetailDevice.location || '-';
            document.getElementById('detail_wifi').textContent = currentDetailDevice.wifi || '-';
            document.getElementById('detail_runtime').textContent = currentDetailDevice.runtime || '-';
            document.getElementById('detail_lastonline').textContent = formatTime(currentDetailDevice.last_update);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const isRecording = currentDetailDevice.run_state === 'recording';
            document.getElementById('detailBtnStart').disabled = isRecording;
            document.getElementById('detailBtnStop').disabled = !isRecording;
            
            // åŠ è½½æ—¶é—´çº¿
            loadDeviceTimeline(cameraId);
            
            // åˆ‡æ¢åˆ°æ—¶é—´çº¿æ ‡ç­¾
            switchDetailTab('timeline');
            
            openModal('deviceDetailModal');
        }

        // åˆ‡æ¢è¯¦æƒ…æ ‡ç­¾é¡µ
        function switchDetailTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®æ ·å¼
            document.getElementById('tab-timeline').classList.remove('active');
            document.getElementById('tab-files').classList.remove('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            if (tabName === 'timeline') {
                document.getElementById('timelineContent').style.display = 'block';
                document.getElementById('filesContent').style.display = 'none';
            } else if (tabName === 'files') {
                document.getElementById('timelineContent').style.display = 'none';
                document.getElementById('filesContent').style.display = 'block';
                loadDeviceFiles(currentCameraId);
            }
        }

        // åŠ è½½è®¾å¤‡æ—¶é—´çº¿ï¼ˆä»tasksè¡¨è·å–çœŸå®æ•°æ®ï¼‰
        async function loadDeviceTimeline(cameraId) {
            const timelineList = document.getElementById('timelineList');
            
            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            timelineList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><div class="loading" style="margin: 0 auto 10px;"></div><div>åŠ è½½æ“ä½œå†å²ä¸­...</div></div>';
            
            try {
                // ä»APIè·å–æ“ä½œå†å²
                const response = await fetch(`/api/camera/${cameraId}/tasks?limit=50`);
                const data = await response.json();
                
                if (!data.success || data.tasks.length === 0) {
                    timelineList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— æ“ä½œè®°å½•</div>';
                    return;
                }
                
                // è½¬æ¢tasksæ•°æ®ä¸ºæ—¶é—´çº¿æ ¼å¼
                const timeline = data.tasks.map(task => {
                    const item = {
                        requestid: task.requestid,
                        requesttype: task.requesttype,
                        state: task.state,
                        description: task.description,
                        created_at: task.created_at,
                        updated_at: task.updated_at
                    };
                    
                    // æ ¹æ®æ“ä½œç±»å‹ç¡®å®šæ ‡é¢˜
                    const typeLabels = {
                        'start_record': 'ğŸ”´ å¼€å§‹å½•åˆ¶',
                        'stop_record': 'â¹ï¸ åœæ­¢å½•åˆ¶',
                        'list_videos': 'ğŸ“¹ æŸ¥è¯¢æ–‡ä»¶',
                        'upload_file': 'â¬†ï¸ ä¸Šä¼ æ–‡ä»¶',
                        'get_upload_status': 'ğŸ“Š æŸ¥è¯¢è¿›åº¦',
                        'get_status': 'ğŸ’“ è®¾å¤‡çŠ¶æ€'
                    };
                    item.title = typeLabels[task.requesttype] || 'ğŸ“Œ è®¾å¤‡æ“ä½œ';
                    
                    // æ ¹æ®çŠ¶æ€ç¡®å®šæ ·å¼
                    if (task.state === 'success') {
                        item.class = 'success';
                        item.dot = 'green';
                        item.stateIcon = 'âœ…';
                    } else if (task.state === 'failed') {
                        item.class = 'error';
                        item.dot = 'red';
                        item.stateIcon = 'âŒ';
                    } else if (task.state === 'calling') {
                        item.class = 'info';
                        item.dot = 'blue';
                        item.stateIcon = 'â³';
                    } else {
                        item.class = 'info';
                        item.dot = 'gray';
                        item.stateIcon = 'â€¢';
                    }
                    
                    return item;
                });
                
                // æ¸²æŸ“æ—¶é—´çº¿
                timelineList.innerHTML = timeline.map(item => `
                    <div class="timeline-item ${item.class}">
                        <div class="timeline-title">
                            <span class="timeline-dot ${item.dot}"></span>
                            ${item.title}
                        </div>
                        <div class="timeline-desc">
                            ${item.stateIcon} ${item.description}
                        </div>
                        <div class="timeline-time">${formatTimeShort(new Date(item.created_at))}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('åŠ è½½æ“ä½œå†å²å¤±è´¥:', error);
                timelineList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff3b30;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // åŠ è½½è®¾å¤‡æ–‡ä»¶åˆ—è¡¨
        async function loadDeviceFiles(cameraId) {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><div class="loading" style="margin: 0 auto 10px;"></div><div>åŠ è½½æ–‡ä»¶åˆ—è¡¨ä¸­...</div></div>';
            
            try {
                // æŸ¥è¯¢è§†é¢‘åˆ—è¡¨
                const cmdResponse = await fetch(`/api/camera/${cameraId}/videos/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const cmdResult = await cmdResponse.json();
                if (!cmdResult.success) {
                    filesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff3b30;">åŠ è½½å¤±è´¥</div>';
                    return;
                }
                
                // ç­‰å¾…ç»“æœ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const resultResponse = await fetch(`/api/videos/${cmdResult.request_id}`);
                const result = await resultResponse.json();
                
                if (result.success && result.data.videos && result.data.videos.length > 0) {
                    renderDetailFiles(result.data.videos);
                } else {
                    filesList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— æ–‡ä»¶</div>';
                }
            } catch (error) {
                console.error('Error loading files:', error);
                filesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff3b30;">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“è¯¦æƒ…æ–‡ä»¶åˆ—è¡¨
        function renderDetailFiles(files) {
            const filesList = document.getElementById('filesList');
            
            filesList.innerHTML = files.map(file => {
                const isVideo = file.file_name.endsWith('.mp4');
                const icon = isVideo ? 'ğŸ¬' : 'ğŸ“„';
                const fileType = isVideo ? 'è§†é¢‘' : 'æ–‡ä»¶';
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                return `
                    <div class="file-item">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <div class="file-icon">${icon}</div>
                            <div class="file-info">
                                <div class="file-name">${file.file_name}</div>
                                <div class="file-meta">${fileType} Â· ${fileSize} MB Â· ${file.start_time}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn" title="ä¸‹è½½" onclick="downloadFile('${file.file_name}')">â¬‡ï¸</button>
                            <button class="file-action-btn" title="åˆ é™¤" onclick="deleteFile('${file.file_name}')" style="color: #ff3b30;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–çŸ­æ—¶é—´
        function formatTimeShort(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // ä»è¯¦æƒ…æ¨¡æ€æ¡†å¯åŠ¨å½•åˆ¶
        function startRecordFromDetail() {
            closeModal('deviceDetailModal');
            openStartRecordModal(currentCameraId);
        }

        // ä»è¯¦æƒ…æ¨¡æ€æ¡†åœæ­¢å½•åˆ¶
        async function stopRecordFromDetail() {
            if (!confirm(`ç¡®è®¤åœæ­¢æ‘„åƒå¤´ ${currentCameraId} çš„å½•åˆ¶ï¼Ÿ`)) {
                return;
            }
            
            await stopRecord(currentCameraId);
            closeModal('deviceDetailModal');
        }

        // åˆ·æ–°è®¾å¤‡è¯¦æƒ…
        async function refreshDeviceDetail() {
            showToast('æ­£åœ¨åˆ·æ–°è®¾å¤‡çŠ¶æ€...', 'info');
            await refreshDeviceList();
            
            // é‡æ–°åŠ è½½è¯¦æƒ…
            setTimeout(() => {
                openDeviceDetail(currentCameraId, { target: {} });
            }, 1000);
        }

        // ä¸Šä¼ é…ç½®
        function uploadConfig() {
            showToast('ä¸Šä¼ é…ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åˆ é™¤è®¾å¤‡ - åœ¨è¡¨æ ¼è¡Œä¸­ä½¿ç”¨çš„ç¡®è®¤å…¥å£
        function confirmDeleteDevice(cameraId) {
            if (!confirm(`ç¡®è®¤åˆ é™¤è®¾å¤‡ ${cameraId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            deleteDevice(cameraId);
        }

        // ä»è¯¦æƒ…æ¨¡æ€æ¡†è§¦å‘åˆ é™¤
        function deleteDeviceFromDetail() {
            if (!currentCameraId) {
                showToast('æœªé€‰å®šè®¾å¤‡', 'error');
                return;
            }
            if (!confirm(`ç¡®è®¤åˆ é™¤è®¾å¤‡ ${currentCameraId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            deleteDevice(currentCameraId);
        }

        // è°ƒç”¨åç«¯åˆ é™¤ API
        async function deleteDevice(cameraId) {
            try {
                const resp = await fetch(`/api/device/${cameraId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await resp.json().catch(() => ({ success: resp.ok }));

                if (resp.ok && result.success !== false) {
                    showToast(`è®¾å¤‡ ${cameraId} å·²åˆ é™¤`, 'success');
                    closeModal('deviceDetailModal');
                    setTimeout(refreshDeviceList, 800);
                } else {
                    const msg = result.message || `åˆ é™¤è®¾å¤‡å¤±è´¥ï¼ˆçŠ¶æ€ç  ${resp.status}ï¼‰`;
                    showToast(msg, 'error');
                }
            } catch (err) {
                console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', err);
                showToast('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'error');
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(fileName) {
            showToast(`å¼€å§‹ä¸‹è½½æ–‡ä»¶: ${fileName}`, 'info');
            // å®é™…åº”è¯¥è°ƒç”¨ä¸‹è½½API
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteFile(fileName) {
            if (confirm(`ç¡®è®¤åˆ é™¤æ–‡ä»¶ ${fileName}ï¼Ÿ`)) {
                showToast(`æ–‡ä»¶åˆ é™¤åŠŸèƒ½å¼€å‘ä¸­...`, 'info');
                // å®é™…åº”è¯¥è°ƒç”¨åˆ é™¤API
            }
        }

        // å…³é—­æ¨¡æ€æ¡†å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('startRecordModal');
                closeModal('videoListModal');
                closeModal('uploadConfirmModal');
                closeModal('deviceDetailModal');
            }
        });
    </script>
</body>
</html>
